<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>MAESTRO – Concise Prototype</title><style>body{margin:0;font:14px system-ui,Segoe UI,Roboto,Helvetica,Arial;background:#f6f7fb;color:#111}header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;padding:8px 12px}h1{font-size:14px;margin:0}nav{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}button.tab{border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:6px 10px;cursor:pointer}button.tab.act{background:#111;color:#fff;border-color:#111}main{padding:12px;max-width:1100px;margin:auto}section{display:none}section.act{display:block}label{font-size:12px;color:#555}input,select,textarea{width:100%;padding:6px 8px;border:1px solid #e5e7eb;border-radius:8px}textarea{min-height:72px}table{width:100%;border-collapse:collapse}th,td{border-bottom:1px solid #e5e7eb;padding:6px;text-align:left;font-size:13px}th{position:sticky;top:0;background:#fafafa;color:#666}a{color:#2563eb;text-decoration:none}a:hover{text-decoration:underline}.row{display:flex;gap:8px;flex-wrap:wrap}.col{flex:1 1 220px}.card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin-bottom:12px}.muted{color:#666;font-size:12px}.chip{display:inline-block;background:#eef2ff;border:1px solid #e0e7ff;border-radius:999px;padding:3px 8px;font-size:12px;margin-right:4px}.heat{display:grid;gap:6px}.cells{display:grid;gap:2px}.c{min-height:22px;border:1px solid #e5e7eb;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px}.g{background:#ecfdf5}.y{background:#fffbeb}.r{background:#fef2f2}.actions{display:flex;gap:6px;flex-wrap:wrap}</style></head><body><header><h1>MAESTRO – Concise Prototype <span id="kpiChip" class="chip">KPI …</span></h1><nav id="tabs"></nav></header><main>
<section id="FORM_New_Request" class="act"><div class="card"><div class="row"><div class="col"><label>Customer</label><select id="rqCustomer"></select></div><div class="col"><label>Engine</label><select id="rqEngine"></select></div><div class="col"><label>Request Type</label><select id="rqType"></select></div><div class="col"><label>Urgency</label><select id="rqUrgency"></select></div><div class="col"><label>Status</label><select id="rqStatus"></select></div><div class="col"><label>Shop</label><select id="rqShop"></select></div><div class="col"><label>Location</label><select id="rqLocation"></select></div><div class="col"><label>Date</label><input type="date" id="rqDate"></div><div class="col"><label>Estimated End</label><input type="date" id="rqEstEnd" readonly></div></div><label>Notes</label><textarea id="rqNotes"></textarea><div class="actions"><button id="btnCreateReq">Create Request</button></div><div class="muted">Estimated End = sum(default op durations for type) + buffer.</div></div><div class="card"><b>Required Ops per Request Type</b><div id="reqTypeHelper" style="margin-top:6px"></div></div><div class="card"><b>Capacity Lookup</b><div class="row" style="margin-top:6px"><div class="col"><label>Shop</label><select id="capShop"></select></div><div class="col"><label>Date</label><input type="date" id="capDate"></div><div class="col"><label>Operation Type</label><select id="capOp"></select></div><div class="col" style="align-self:end"><button id="btnCapLookup">Lookup</button></div></div><div id="capResult" class="muted" style="margin-top:6px"></div></div></section>
<section id="FORM_Edit_Operations"><div class="card"><div class="row"><div class="col"><label>Op ID</label><input id="opId" readonly placeholder="(auto)"></div><div class="col"><label>Request</label><select id="opReq"></select></div><div class="col"><label>Status</label><select id="opStatus"></select></div><div class="col"><label>Shop</label><select id="opShop"></select></div><div class="col"><label>Op Type</label><select id="opType"></select></div><div class="col"><label>Start</label><input type="date" id="opStart"></div><div class="col"><label>Dur (h)</label><input type="number" id="opDur" min="1" step="1"></div><div class="col"><label>Finish</label><input type="date" id="opFinish" readonly></div></div><div class="actions"><button id="btnSaveOp">Save</button><button id="btnDeleteOp">Delete</button><span id="opMode" class="chip">New</span></div><div class="muted">Op types filtered by shop. Duration preloads from defaults.</div></div><div class="card"><b>Shop Capability</b><div id="shopHelper" style="margin-top:6px"></div></div></section>
<section id="TR_Maint_Requests"><div class="card"><div class="actions"><input id="rqSearch" placeholder="Search…"></div><div class="muted">Click <b>ID</b> or <b>Ops #</b> to navigate.</div><div style="overflow:auto;max-height:60vh"><table><thead><tr><th>ID</th><th>Customer</th><th>Engine</th><th>Type</th><th>Urg</th><th>Status</th><th>Shop</th><th>Loc</th><th>Req Date</th><th>Est End</th><th>Ops #</th></tr></thead><tbody id="rqTable"></tbody></table></div></div></section>
<section id="OP_Maint_Operations"><div class="card"><div class="actions"><input id="opSearch" placeholder="Filter op/shop/status"><input id="opFilterReq" type="number" placeholder="Request ID" style="width:140px"></div><div class="muted">Click <b>Op ID</b> to edit, <b>Request</b> to filter.</div><div style="overflow:auto;max-height:60vh"><table><thead><tr><th>Op ID</th><th>Request</th><th>Shop</th><th>Op Type</th><th>Start</th><th>Dur</th><th>Finish</th><th>Status</th></tr></thead><tbody id="opTable"></tbody></table></div></div></section>
<section id="MD_Lists"><div class="card"><div class="actions"><button id="btnApplyMD">Apply Changes</button><button id="btnResetMD">Reset</button><button id="btnCopyJSON">Copy JSON</button><button id="btnDownloadJSON">Download</button><label><input type="file" id="fileImport" accept="application/json" hidden><span class="chip" style="cursor:pointer" id="btnImport">Import JSON</span></label></div><div class="row" id="mdGrid"></div><div class="card"><b>Mapping: Request Type → 4 Ops</b><div id="mappingTable" style="margin-top:6px"></div></div><div class="card"><b>Default Duration (h)</b><div id="durationTable" style="margin-top:6px"></div></div><div class="card"><b>JSON Viewer</b><div id="jsonViewer" style="margin-top:6px"></div></div></div></section>
<section id="KPI_Dashboard"><div class="card"><b>On‑time % (Urgent)</b><div id="kpiUrgent" style="font-size:36px;font-weight:800;margin:6px 0">—%</div><div class="muted">Urgent = High/Critical. On‑time if max op finish ≤ Est End.</div></div><div class="card"><b>Capacity Heatmap (8 weeks)</b><div id="heatmap" style="margin-top:6px"></div></div></section>
</main><script>const S={mdLists:{},requestTypeToOps:{},opDur:{},shops:[],shopCapabilities:{},requests:[],operations:[],tabs:["FORM_New_Request","FORM_Edit_Operations","TR_Maint_Requests","OP_Maint_Operations","MD_Lists","KPI_Dashboard"],seq:{req:1000,op:5000}};const F=(d)=>new Date(d).toISOString().slice(0,10),TD=()=>F(new Date()),AD=(d,n)=>{const t=new Date(d);t.setDate(t.getDate()+n);return F(t)},AH=(d,h)=>{const t=new Date(d);t.setHours(t.getHours()+h);return F(t)},R=(a,b)=>Math.floor(Math.random()*(b-a+1))+a,P=a=>a[Math.floor(Math.random()*a.length)],U=a=>[...new Set(a)];function tabNav(){const n=document.getElementById('tabs');n.innerHTML='';S.tabs.forEach(id=>{const b=document.createElement('button');b.className='tab'+(document.getElementById(id).classList.contains('act')?' act':'');b.textContent=id.replace(/_/g,' ');b.onclick=()=>sw(id);n.appendChild(b)})}function sw(id){document.querySelectorAll('section').forEach(s=>s.classList.remove('act'));document.getElementById(id).classList.add('act');document.querySelectorAll('button.tab').forEach(t=>t.classList.toggle('act',t.textContent.trim()===id.replace(/_/g,' ')))}function fill(id,arr){const s=document.getElementById(id);if(!s)return;s.innerHTML='';arr.forEach(x=>{const o=document.createElement('option');o.value=o.textContent=x;s.appendChild(o)})}
function seedMasterData(){S.mdLists={Urgency:["Low","Normal","High","Critical"],Status:["Planned","In Progress","Done","Blocked"],Shop:["Alpha","Bravo","Charlie","Delta","Echo","Foxtrot","Golf","Hotel"],Location:["Paris","Lyon","Hamburg","Madrid","Turin"],"Operation Type":["Disassembly","Cleaning","Inspection","Repair","Reassembly","Test Bench","Software Update","Calibration","Module Swap","Welding","Painting","Quality Check"],"Engine Model":["AeroX-200","AeroX-300","SkyJet-9","Falcon-21","Orion-7"],Customer:["Air France","Lufthansa","Iberia","EasyJet","Ryanair","KLM"],"Request Type":["Inspection","Repair","Overhaul","Upgrade","Diagnostics"]};S.shops=[...S.mdLists.Shop];const ops=S.mdLists["Operation Type"];S.requestTypeToOps={};S.mdLists["Request Type"].forEach(rt=>{let s=[];while(s.length<4){const o=P(ops);if(!s.includes(o))s.push(o)}S.requestTypeToOps[rt]=s});S.opDur={};ops.forEach(o=>S.opDur[o]=R(3,16));S.shopCapabilities={};S.shops.forEach(s=>{const allowed=U(Array(R(3,6)).fill(0).map(()=>P(ops)));const loc=P(S.mdLists.Location);const exc={};for(let i=0;i<6;i++){exc[AD(TD(),R(0,30))]=R(3,12)}S.shopCapabilities[s]={location:loc,defaultCap:R(6,12),allowedOps:allowed,exceptions:exc}})}
function seedTransactions(){S.requests=[];S.operations=[];S.seq={req:1000,op:5000};for(let i=0;i<50;i++){const cust=P(S.mdLists.Customer),eng=P(S.mdLists["Engine Model"]),type=P(S.mdLists["Request Type"]),urg=P(S.mdLists.Urgency),st=P(S.mdLists.Status),shop=P(S.shops),loc=S.shopCapabilities[shop].location,date=AD(TD(),-R(0,60)),est=estEnd(type,date),id=++S.seq.req;S.requests.push({id,customer:cust,engine:eng,type:Rt(type),urgency:urg,status:st,shop,location:loc,date,estEnd:est,notes:"Seed"})}while(S.operations.length<200){const rq=P(S.requests),ops=U([...S.requestTypeToOps[rq.type],...pickSome(S.mdLists["Operation Type"],R(0,1))]),ot=P(ops),shop=P(S.shops.filter(sh=>S.shopCapabilities[sh].allowedOps.includes(ot))||[rq.shop]),start=AD(rq.date,R(0,20)),dur=S.opDur[ot]||R(2,12),finish=AH(start,dur),st=P(S.mdLists.Status),id=++S.seq.op;S.operations.push({id,requestId:rq.id,shop,opType:ot,start,dur,finish,status:st})}}function pickSome(a,n){const b=[...a],o=[];for(let i=0;i<n&&b.length;i++){const ix=R(0,b.length-1);o.push(b[ix]);b.splice(ix,1)}return o}
function renderReqTypeHelper(){const host=document.getElementById('reqTypeHelper');host.innerHTML='';S.mdLists["Request Type"].forEach(rt=>{const d=document.createElement('div');d.className='muted';d.innerHTML=`<b>${rt}</b> — ${S.requestTypeToOps[rt].map(o=>`<span class=\"chip\">${o}</span>`).join(' ')}`;host.appendChild(d)})}
function renderShopHelper(sel){const host=document.getElementById('shopHelper');const s=sel||document.getElementById('opShop')?.value||S.shops[0];const c=S.shopCapabilities[s];if(!c){host.textContent='No data';return}host.innerHTML=`<div class="muted">Location: <b>${c.location}</b> · Default cap/day: <b>${c.defaultCap}</b></div><div style="margin-top:4px">${c.allowedOps.map(o=>`<span class=chip>${o}</span>`).join(' ')}</div>`}
function capFor(shop,date){const c=S.shopCapabilities[shop];if(!c)return{capacity:0,used:0,free:0};const cap=c.exceptions[date]??c.defaultCap;const used=S.operations.filter(o=>o.shop===shop&&o.start===date).length;return{capacity:cap,used,free:Math.max(cap-used,0)}}function onCapLookup(){const s=document.getElementById('capShop').value,d=document.getElementById('capDate').value||TD(),o=document.getElementById('capOp').value,{capacity,used,free}=capFor(s,d);document.getElementById('capResult').innerHTML=`<b>${d}</b> @ <b>${s}</b> (${o}): cap <b>${capacity}</b>, used <b>${used}</b>, free <b>${free}</b>`}
function estEnd(rt,dt){if(!rt||!dt)return'';let h=0;S.requestTypeToOps[rt].forEach(o=>h+=(S.opDur[o]||8));return AH(dt,h+24)}function recalc(){document.getElementById('rqEstEnd').value=estEnd(document.getElementById('rqType').value,document.getElementById('rqDate').value)}function must(x){for(const[k,v]of Object.entries(x))if(!v){alert('Missing: '+k);return false}return true}
function onCreateRequest(){const r={customer:V('rqCustomer'),engine:V('rqEngine'),type:V('rqType'),urgency:V('rqUrgency'),status:V('rqStatus'),shop:V('rqShop'),location:V('rqLocation'),date:V('rqDate'),estEnd:V('rqEstEnd'),notes:(V('rqNotes')||'').trim()};if(!must(r))return;r.id=++S.seq.req;S.requests.push(r);fills();rendReq();rendJSON();updKPI();alert('Request #'+r.id+' created')}function V(id){return document.getElementById(id).value}
function onShop(){const s=V('opShop');const a=S.shopCapabilities[s]?.allowedOps||S.mdLists["Operation Type"];fill('opType',a);renderShopHelper(s)}function onType(){const t=V('opType');document.getElementById('opDur').value=S.opDur[t]||8;onStartDur()}function onStartDur(){const st=V('opStart'),d=parseInt(V('opDur')||'0',10);document.getElementById('opFinish').value=(st&&d>0)?AH(st,d):''}
function onSaveOp(){const id=V('opId');const p={requestId:parseInt(V('opReq'),10),status:V('opStatus'),shop:V('opShop'),opType:V('opType'),start:V('opStart'),dur:parseInt(V('opDur')||'0',10),finish:V('opFinish')};if(!must(p))return;if(id){const i=S.operations.findIndex(o=>String(o.id)===String(id));if(i>=0)S.operations[i]={id:S.operations[i].id,...p}}else{const nid=++S.seq.op;S.operations.push({id:nid,...p});document.getElementById('opId').value=nid}rendOps();rendJSON();updKPI();document.getElementById('opMode').textContent=id?'Updated':'Created'}function onDelOp(){const id=V('opId');if(!id)return alert('Nothing to delete');const i=S.operations.findIndex(o=>String(o.id)===String(id));if(i>=0){S.operations.splice(i,1);rendOps();rendJSON();updKPI();alert('Deleted #'+id)}else alert('Not found')}function loadOp(id){const o=S.operations.find(x=>String(x.id)===String(id));if(!o)return;['opId','opReq','opStatus','opShop','opType','opStart','opDur','opFinish'].forEach(()=>{});document.getElementById('opId').value=o.id;document.getElementById('opReq').value=o.requestId;document.getElementById('opStatus').value=o.status;document.getElementById('opShop').value=o.shop;onShop();document.getElementById('opType').value=o.opType;onType();document.getElementById('opStart').value=o.start;document.getElementById('opDur').value=o.dur;onStartDur();sw('FORM_Edit_Operations');document.getElementById('opMode').textContent='Edit'}
function rendReq(){const term=(document.getElementById('rqSearch')?.value||'').toLowerCase();const tb=document.getElementById('rqTable');tb.innerHTML='';S.requests.filter(r=>{const s=`${r.customer} ${r.engine} ${r.type} ${r.status} ${r.urgency}`.toLowerCase();return !term||s.includes(term)}).sort((a,b)=>b.id-a.id).forEach(r=>{const n=S.operations.filter(o=>o.requestId===r.id).length;const tr=document.createElement('tr');tr.innerHTML=`<td><a href="#" data-rid="${r.id}">${r.id}</a></td><td>${r.customer}</td><td>${r.engine}</td><td>${r.type}</td><td>${r.urgency}</td><td>${r.status}</td><td>${r.shop}</td><td>${r.location}</td><td>${r.date}</td><td>${r.estEnd}</td><td><a href="#" data-rid="${r.id}">${n}</a></td>`;tb.appendChild(tr)});tb.querySelectorAll('a[data-rid]').forEach(a=>a.onclick=(e)=>{e.preventDefault();toOpsByReq(a.getAttribute('data-rid'))})}
function toOpsByReq(id){document.getElementById('opFilterReq').value=id;sw('OP_Maint_Operations');rendOps();location.hash=`#tab=OP_Maint_Operations&req=${encodeURIComponent(id)}`}
function rendOps(){const t=(document.getElementById('opSearch')?.value||'').toLowerCase();const rf=parseInt(document.getElementById('opFilterReq')?.value||'0',10);const tb=document.getElementById('opTable');tb.innerHTML='';S.operations.filter(o=>{const s=`${o.opType} ${o.shop} ${o.status}`.toLowerCase();if(t&&!s.includes(t))return false;return !rf||o.requestId===rf}).sort((a,b)=>b.id-a.id).forEach(o=>{const tr=document.createElement('tr');tr.innerHTML=`<td><a href="#" data-oid="${o.id}">${o.id}</a></td><td><a href="#" data-rid="${o.requestId}">${o.requestId}</a></td><td>${o.shop}</td><td>${o.opType}</td><td>${o.start}</td><td>${o.dur}</td><td>${o.finish}</td><td>${o.status}</td>`;tb.appendChild(tr)});tb.querySelectorAll('a[data-oid]').forEach(a=>a.onclick=(e)=>{e.preventDefault();loadOp(a.getAttribute('data-oid'))});tb.querySelectorAll('a[data-rid]').forEach(a=>a.onclick=(e)=>{e.preventDefault();toOpsByReq(a.getAttribute('data-rid'))})}
function rendMD(){const host=document.getElementById('mdGrid');host.innerHTML='';Object.entries(S.mdLists).forEach(([n,items])=>{const d=document.createElement('div');d.className='col';d.innerHTML=`<div class="card"><b>${n}</b><textarea id="md_${cid(n)}">${items.join('\n')}</textarea></div>`;host.appendChild(d)})}function rendMap(){const host=document.getElementById('mappingTable');host.innerHTML='';const ops=S.mdLists["Operation Type"];const t=document.createElement('table');t.innerHTML='<thead><tr><th>Request Type</th><th>Op 1</th><th>Op 2</th><th>Op 3</th><th>Op 4</th></tr></thead>';const b=document.createElement('tbody');S.mdLists["Request Type"].forEach(rt=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${rt}</td>`;for(let i=0;i<4;i++){const s=document.createElement('select');s.id=`map_${cid(rt)}_${i}`;ops.forEach(o=>{const op=document.createElement('option');op.value=op.textContent=o;s.appendChild(op)});s.value=S.requestTypeToOps[rt][i]||ops[0];const td=document.createElement('td');td.appendChild(s);tr.appendChild(td)}b.appendChild(tr)});t.appendChild(b);host.appendChild(t)}function rendDur(){const host=document.getElementById('durationTable');host.innerHTML='';const t=document.createElement('table');t.innerHTML='<thead><tr><th>Operation Type</th><th>Default (h)</th></tr></thead>';const b=document.createElement('tbody');S.mdLists["Operation Type"].forEach(o=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${o}</td><td><input type=number id="dur_${cid(o)}" min=1 step=1 value="${S.opDur[o]||8}"></td>`;b.appendChild(tr)});t.appendChild(b);host.appendChild(t)}
function cid(s){return s.replace(/\s+/g,'_').replace(/[^\w_\-]/g,'')}function applyMD(){const nl={};Object.keys(S.mdLists).forEach(n=>{const ta=document.getElementById('md_'+cid(n));nl[n]=U(ta.value.split(/\n+/).map(x=>x.trim()).filter(Boolean))});S.mdLists=nl;S.shops=[...S.mdLists.Shop];const nm={};S.mdLists["Request Type"].forEach(rt=>{const a=[];for(let i=0;i<4;i++){const s=document.getElementById(`map_${cid(rt)}_${i}`);if(s)a.push(s.value)}while(a.length<4)a.push(P(S.mdLists["Operation Type"]));nm[rt]=U(a).slice(0,4);while(nm[rt].length<4){const o=P(S.mdLists["Operation Type"]);if(!nm[rt].includes(o))nm[rt].push(o)}});S.requestTypeToOps=nm;const nd={};S.mdLists["Operation Type"].forEach(o=>{const v=parseInt(document.getElementById('dur_'+cid(o))?.value||'8',10);nd[o]=Math.max(1,Math.min(v||8,96))});S.opDur=nd;const prev={...S.shopCapabilities};S.shopCapabilities={};S.shops.forEach(s=>{const k=prev[s];const allowed=k?k.allowedOps.filter(o=>S.mdLists["Operation Type"].includes(o)):U(Array(R(3,6)).fill(0).map(()=>P(S.mdLists["Operation Type"])));S.shopCapabilities[s]={location:k?.location||P(S.mdLists.Location),defaultCap:k?.defaultCap||R(6,12),allowedOps:allowed.length?allowed:pickSome(S.mdLists["Operation Type"],4),exceptions:k?.exceptions||{}}});fills();renderReqTypeHelper();renderShopHelper();rendReq();rendOps();rendMap();rendDur();kpi();rendJSON();updKPI();alert('Master data updated')}
function kpi(){const urg=S.requests.filter(r=>['High','Critical'].includes(r.urgency));let ok=0,tot=0;urg.forEach(r=>{const ops=S.operations.filter(o=>o.requestId===r.id);if(!ops.length)return;tot++;const max=ops.reduce((m,o)=>o.finish>m?o.finish:m,'1970-01-01');if(max<=r.estEnd)ok++});const p=tot?Math.round(ok/tot*100):0;document.getElementById('kpiUrgent').textContent=p+'%';const host=document.getElementById('heatmap');host.innerHTML='';const shopsByLoc={};Object.entries(S.shopCapabilities).forEach(([s,c])=>{(shopsByLoc[c.location]??=[]).push(s)});const start=TD();const weeks=8;Object.entries(shopsByLoc).forEach(([loc,shops])=>{const wrap=document.createElement('div');wrap.className='heat';wrap.innerHTML=`<div class=muted><b>${loc}</b> (${shops.length} shops)</div>`;shops.forEach(s=>{const row=document.createElement('div');row.className='cells';row.style.gridTemplateColumns=`repeat(${weeks},1fr)`;for(let w=0;w<weeks;w++){const wk=AD(start,w*7);const util=utilW(s,wk);const cls=util<.6?'g':util<.9?'y':'r';const cell=document.createElement('div');cell.className='c '+cls;cell.title=`${s} · week ${wk}: ${(util*100).toFixed(0)}%`;cell.textContent=(util*100).toFixed(0)+'%';row.appendChild(cell)}wrap.appendChild(document.createElement('div')).textContent=s;wrap.appendChild(row)});host.appendChild(wrap)})}function utilW(shop,wk){const c=S.shopCapabilities[shop];if(!c)return 0;const cap=c.defaultCap*5;let used=0;S.operations.forEach(o=>{if(o.shop===shop&&o.start>=wk&&o.start<=AD(wk,6))used++});return cap?Math.min(used/cap,1.2):0}function updKPI(){const urg=S.requests.filter(r=>['High','Critical'].includes(r.urgency));let ok=0,tot=0;urg.forEach(r=>{const ops=S.operations.filter(o=>o.requestId===r.id);if(!ops.length)return;tot++;const m=ops.reduce((x,o)=>o.finish>x?o.finish:x,'1970-01-01');if(m<=r.estEnd)ok++});const p=tot?Math.round(ok/tot*100):0;document.getElementById('kpiChip').textContent='KPI Urgent '+p+'%'}
function jsonSections(){return{mdLists:S.mdLists,requestTypeToOps:S.requestTypeToOps,opDur:S.opDur,shops:S.shops,shopCapabilities:S.shopCapabilities,requests:S.requests,operations:S.operations,seq:S.seq}}function rendJSON(){const host=document.getElementById('jsonViewer');host.innerHTML='';Object.entries(jsonSections()).forEach(([k,v])=>{const d=document.createElement('details');const s=document.createElement('summary');s.textContent=k;const pre=document.createElement('pre');pre.textContent=JSON.stringify(v,null,2);d.append(s,pre);host.appendChild(d)})}function copyJSON(){navigator.clipboard.writeText(JSON.stringify(jsonSections(),null,2)).then(()=>alert('Copied'))}function dlJSON(){const blob=new Blob([JSON.stringify(jsonSections(),null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='maestro_state_'+TD()+'.json';document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url)}function doImport(f){const r=new FileReader();r.onload=()=>{try{const d=JSON.parse(r.result);["mdLists","requestTypeToOps","opDur","shops","shopCapabilities","requests","operations","seq"].forEach(k=>{if(!(k in d))throw new Error('Missing '+k)});Object.assign(S,d);tabNav();fills();renderReqTypeHelper();renderShopHelper();rendReq();rendOps();rendMD();rendMap();rendDur();kpi();rendJSON();updKPI();alert('Import OK')}catch(e){alert('Invalid JSON: '+e.message)}};r.readAsText(f)}
function fills(){fill('rqCustomer',S.mdLists.Customer);fill('rqEngine',S.mdLists["Engine Model"]);fill('rqType',S.mdLists["Request Type"]);fill('rqUrgency',S.mdLists.Urgency);fill('rqStatus',S.mdLists.Status);fill('rqShop',S.mdLists.Shop);fill('rqLocation',S.mdLists.Location);fill('capShop',S.mdLists.Shop);fill('capOp',S.mdLists["Operation Type"]);fill('opReq',S.requests.map(r=>r.id).sort((a,b)=>a-b));fill('opStatus',S.mdLists.Status);fill('opShop',S.mdLists.Shop);onShop();onType()}function bind(){document.getElementById('btnCreateReq').onclick=onCreateRequest;document.getElementById('rqType').onchange=recalc;document.getElementById('rqDate').onchange=recalc;document.getElementById('btnCapLookup').onclick=onCapLookup;document.getElementById('btnSaveOp').onclick=onSaveOp;document.getElementById('btnDeleteOp').onclick=onDelOp;document.getElementById('opShop').onchange=onShop;document.getElementById('opType').onchange=onType;document.getElementById('opStart').onchange=onStartDur;document.getElementById('opDur').oninput=onStartDur;document.getElementById('rqSearch').oninput=rendReq;document.getElementById('opSearch').oninput=rendOps;document.getElementById('opFilterReq').oninput=rendOps;document.getElementById('btnApplyMD').onclick=applyMD;document.getElementById('btnResetMD').onclick=()=>{seedMasterData();seedTransactions();fills();renderReqTypeHelper();renderShopHelper();rendReq();rendOps();rendMD();rendMap();rendDur();kpi();rendJSON();updKPI();alert('Re-seeded')};document.getElementById('btnCopyJSON').onclick=copyJSON;document.getElementById('btnDownloadJSON').onclick=dlJSON;document.getElementById('btnImport').onclick=()=>document.getElementById('fileImport').click();document.getElementById('fileImport').onchange=e=>{if(e.target.files[0])doImport(e.target.files[0])}}
function applyHash(){const p=new URLSearchParams((location.hash||'').replace(/^#/,''));const t=p.get('tab');if(t&&document.getElementById(t))sw(t);const r=p.get('req');if(r&&document.getElementById('opFilterReq')){document.getElementById('opFilterReq').value=parseInt(r,10)||'';if(t==='OP_Maint_Operations'||document.getElementById('OP_Maint_Operations').classList.contains('act'))rendOps()}}
function Rt(x){return x}function init(){seedMasterData();seedTransactions();tabNav();fills();renderReqTypeHelper();renderShopHelper();rendReq();rendOps();rendMD();rendMap();rendDur();kpi();rendJSON();bind();document.getElementById('rqDate').value=TD();recalc();updKPI();applyHash();addEventListener('hashchange',applyHash)}document.addEventListener('DOMContentLoaded',init);
</script></body></html>
