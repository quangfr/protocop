<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MAESTRO – Aircraft Engine Maintenance (Prototype)</title>
  <style>
    :root{
      --bg:#f7f7fb; --card:#ffffff; --ink:#1f2937; --muted:#6b7280; --accent:#2563eb;
      --accent-2:#10b981; --warn:#f59e0b; --danger:#ef4444; --border:#e5e7eb;
      --chip:#f1f5f9; --sticky:#f8fafc; --req:#fde68a; --opt:#bfdbfe;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#fff,rgba(255,255,255,.96));border-bottom:1px solid var(--border)}
    .bar{max-width:1200px;margin:auto;display:flex;align-items:center;gap:16px;padding:14px 20px}
    .logo{font-weight:800;letter-spacing:.5px}
    .logo small{font-weight:600;color:var(--muted)}
    nav.tabs{display:flex;flex-wrap:wrap;gap:8px;margin-left:auto}
    nav.tabs button{appearance:none;border:1px solid var(--border);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;color:var(--ink)}
    nav.tabs button.active{border-color:var(--accent);color:#fff;background:var(--accent)}
    main{max-width:1200px;margin:18px auto;padding:0 20px 40px}
    .grid{display:grid;gap:16px}
    .two-cols{grid-template-columns:1.4fr .9fr}
    @media (max-width: 980px){.two-cols{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 4px 10px rgba(0,0,0,.04);padding:16px}
    h1,h2{margin:0 0 10px}
    h2{font-size:18px}
    h3{margin:16px 0 8px;font-size:15px;color:var(--muted)}
    .row{display:grid;grid-template-columns:repeat(6,1fr);gap:12px}
    .row .col-2{grid-column:span 2}
    .row .col-3{grid-column:span 3}
    .row .col-6{grid-column:span 6}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;color:var(--ink)}
    input[readonly]{background:#fafafa}
    .req{background:var(--req)}
    .opt{background:var(--opt)}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.ghost{background:transparent}
    .btn.success{background:var(--accent-2);border-color:var(--accent-2);color:#fff}
    .btn.warn{background:var(--warn);border-color:var(--warn);color:#111}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .btnbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .helper{font-size:13px;line-height:1.35}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px}
    .muted{color:var(--muted)}
    .tab{display:none}
    .tab.active{display:block}

    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:var(--sticky);border-bottom:1px solid var(--border);font-size:12px;text-align:left;padding:10px}
    tbody td{border-bottom:1px dashed var(--border);padding:10px;vertical-align:top;font-size:13px}
    tbody tr:hover{background:#fafafa}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
    .pill.aog{background:#fef3c7;border-color:#f59e0b}
    .pill.routine{background:#e0f2fe;border-color:#38bdf8}
    .link{color:var(--accent);cursor:pointer;text-decoration:underline}

    .progress{height:10px;background:#eef2ff;border-radius:10px;overflow:hidden;border:1px solid var(--border)}
    .progress>span{display:block;height:100%;background:var(--accent)}
    .heatmap{display:grid;grid-template-columns:repeat(14,20px);gap:4px}
    .cell{width:20px;height:20px;border-radius:4px;border:1px solid var(--border);background:#e5e7eb}

    pre.json{max-height:320px;overflow:auto;background:#0b1021;color:#e6edf3;padding:12px;border-radius:12px;border:1px solid #111827}
    code.k{color:#60a5fa}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin:8px 0}

    .note{font-size:12px;color:var(--muted)}
    .heatmapRow{display:flex;align-items:center;gap:8px;margin-top:6px;margin-bottom:6px}
    .heatmapRow .label{width:160px;font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="logo">MAESTRO <small>• Aircraft Engine Maintenance</small></div>
      <nav class="tabs" id="tabs"></nav>
    </div>
  </header>
  <main>
    <!-- New Request -->
    <section id="tab-FORM_New_Request" class="tab active">
      <div class="grid two-cols">
        <div class="card">
          <h2>Nouvelle Demande</h2>
          <div class="note">Champs obligatoires en jaune, optionnels en bleu.</div>
          <form id="newReqForm">
            <div class="row">
              <div class="col-2">
                <label>Modèle moteur *</label>
                <select id="reqEngineModel" class="req" required></select>
              </div>
              <div class="col-2">
                <label>N° de série moteur *</label>
                <input id="reqEngineSerial" class="req" placeholder="ex. CFM56-7B SN 123456" required />
              </div>
              <div class="col-2">
                <label>Client *</label>
                <select id="reqCustomer" class="req" required></select>
              </div>
              <div class="col-2">
                <label>Urgence *</label>
                <select id="reqUrgency" class="req" required></select>
              </div>
              <div class="col-2">
                <label>Type de demande *</label>
                <select id="reqType" class="req" required></select>
              </div>
              <div class="col-2">
                <label>Date de demande *</label>
                <input type="date" id="reqDate" class="req" required />
              </div>
              <div class="col-2">
                <label>Date de fin estimée (ETA)</label>
                <input type="date" id="reqEstEnd" readonly />
              </div>
              <div class="col-6">
                <label>Notes</label>
                <input id="reqNotes" class="opt" placeholder="Contexte client, symptômes, contraintes Test Cell, etc." />
              </div>
            </div>
            <div class="btnbar">
              <button type="submit" class="btn primary">Créer la demande</button>
              <button type="button" class="btn ghost" id="btnRecalcEta">Recalculer l'ETA</button>
            </div>
          </form>
        </div>
        <div class="card">
          <h2>Assistant</h2>
          <h3>Opérations requises par type de demande</h3>
          <div id="reqTypeHelper" class="helper"></div>
          <h3>Capacity Lookup</h3>
          <div class="row">
            <div class="col-2">
              <label>Atelier</label>
              <select id="capShop"></select>
            </div>
            <div class="col-2">
              <label>Type d'opération</label>
              <select id="capOpType"></select>
            </div>
            <div class="col-2">
              <label>Date</label>
              <input type="date" id="capDate" />
            </div>
            <div class="col-2" style="align-self:end">
              <button id="capCheck" class="btn">Vérifier</button>
            </div>
          </div>
          <div id="capResult" class="helper" style="margin-top:8px"></div>
          <h3>Guide Ateliers</h3>
          <div id="shopHelper" class="helper"></div>
        </div>
      </div>
    </section>

    <!-- Edit Operations -->
    <section id="tab-FORM_Edit_Operations" class="tab">
      <div class="grid two-cols">
        <div class="card">
          <h2>Édition d'opérations</h2>
          <form id="opForm">
            <div class="row">
              <div class="col-2">
                <label>Mode</label>
                <input id="opMode" value="Nouveau" readonly />
              </div>
              <div class="col-2">
                <label>ID Opération</label>
                <input id="opId" readonly />
              </div>
              <div class="col-2">
                <label>Demande (ID) *</label>
                <select id="opReqId" class="req" required></select>
              </div>
              <div class="col-2">
                <label>Atelier *</label>
                <select id="opShop" class="req" required></select>
              </div>
              <div class="col-2">
                <label>Type d'opération *</label>
                <select id="opType" class="req" required></select>
              </div>
              <div class="col-2">
                <label>Début *</label>
                <input type="date" id="opStart" class="req" required />
              </div>
              <div class="col-2">
                <label>Durée (jours) *</label>
                <input type="number" id="opDur" class="req" min="1" value="1" required />
              </div>
              <div class="col-2">
                <label>Fin</label>
                <input type="date" id="opEnd" readonly />
              </div>
              <div class="col-2">
                <label>Statut</label>
                <select id="opStatus"></select>
              </div>
            </div>
            <div class="btnbar">
              <button type="submit" class="btn success">Enregistrer</button>
              <button type="button" id="opDelete" class="btn danger" disabled>Supprimer</button>
              <button type="button" id="opReset" class="btn ghost">Réinitialiser</button>
              <button type="button" id="opAutoSlot" class="btn warn">Auto-planifier</button>
            </div>
            <div class="note" id="opMsg"></div>
          </form>
        </div>
        <div class="card">
          <h2>Aide Atelier</h2>
          <div id="opShopHelper" class="helper"></div>
        </div>
      </div>
    </section>

    <!-- Requests Table -->
    <section id="tab-TR_Maint_Requests" class="tab">
      <div class="card">
        <h2>Demandes de maintenance</h2>
        <div class="row" style="margin:8px 0 4px">
          <div class="col-2"><label>Filtrer Client</label><select id="fltCustomer"></select></div>
          <div class="col-2"><label>Filtrer Urgence</label><select id="fltUrgency"></select></div>
          <div class="col-2"><label>Filtrer Type</label><select id="fltReqType"></select></div>
          <div class="col-2" style="align-self:end"><button id="btnClearFilters" class="btn ghost">Réinitialiser</button></div>
        </div>
        <div style="overflow:auto;max-height:520px">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Modèle</th>
                <th>Serial</th>
                <th>Client</th>
                <th>Urgence</th>
                <th>Type</th>
                <th>Date</th>
                <th>ETA</th>
                <th>Ops #</th>
              </tr>
            </thead>
            <tbody id="requestsTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Operations Table -->
    <section id="tab-OP_Maint_Operations" class="tab">
      <div class="card">
        <h2>Opérations planifiées</h2>
        <div class="row" style="margin:8px 0 4px">
          <div class="col-2"><label>Filtrer Demande</label><select id="fltOpReq"></select></div>
          <div class="col-2"><label>Filtrer Atelier</label><select id="fltOpShop"></select></div>
          <div class="col-2"><label>Filtrer Type</label><select id="fltOpType"></select></div>
          <div class="col-2" style="align-self:end"><button id="btnClearOpFilters" class="btn ghost">Réinitialiser</button></div>
        </div>
        <div style="overflow:auto;max-height:520px">
          <table>
            <thead>
              <tr>
                <th>Op ID</th>
                <th>Demande</th>
                <th>Atelier</th>
                <th>Type</th>
                <th>Début</th>
                <th>Durée</th>
                <th>Fin</th>
                <th>Statut</th>
              </tr>
            </thead>
            <tbody id="operationsTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Master Data & JSON -->
    <section id="tab-MD_Lists" class="tab">
      <div class="grid">
        <div class="card">
          <h2>Listes maîtres</h2>
          <div id="mdGrid" class="grid" style="grid-template-columns:repeat(4,1fr)"></div>
          <div class="btnbar"><button id="applyMD" class="btn primary">Appliquer les changements</button></div>
        </div>
        <div class="card">
          <h2>Mapping Type de demande → 4 opérations</h2>
          <div style="overflow:auto;max-height:260px">
            <table>
              <thead><tr><th>Type de demande</th><th>Opérations (ordre)</th></tr></thead>
              <tbody id="mapTbody"></tbody>
            </table>
          </div>
        </div>
        <div class="card">
          <h2>Durées standard (jours)</h2>
          <div style="overflow:auto;max-height:260px">
            <table>
              <thead><tr><th>Type d'opération</th><th>Durée</th></tr></thead>
              <tbody id="durTbody"></tbody>
            </table>
          </div>
        </div>
        <div class="card">
          <h2>JSON Viewer</h2>
          <div class="toolbar">
            <button class="btn" id="jsonCopy">Copier</button>
            <button class="btn" id="jsonDownload">Télécharger</button>
          </div>
          <pre class="json" id="jsonOut"></pre>
        </div>
      </div>
    </section>

    <!-- KPI Dashboard -->
    <section id="tab-KPI_Dashboard" class="tab">
      <div class="grid">
        <div class="card">
          <h2>Ponctualité AOG</h2>
          <div id="kpiAOG" class="helper"></div>
          <div class="progress" style="margin-top:8px"><span id="kpiAOGBar" style="width:0%"></span></div>
        </div>
        <div class="card">
          <h2>Charge par atelier (14 jours)</h2>
          <div id="kpiShopSummary" class="helper"></div>
          <div id="shopHeatContainer"></div>
        </div>
        <div class="card">
          <h2>Diagnostics</h2>
          <div class="btnbar"><button id="btnSelfTest" class="btn">Lancer les tests</button></div>
          <div id="selfTest" class="helper"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
  const S = {
    mdLists:{}, requestTypeToOps:{}, opDur:{}, shops:[], shopCapabilities:{},
    requests:[], operations:[], bookings:{}, tabs:["FORM_New_Request","FORM_Edit_Operations","TR_Maint_Requests","OP_Maint_Operations","MD_Lists","KPI_Dashboard"]
  };

  // ---------- Utilities ----------
  const $ = sel => document.querySelector(sel);
  const el = (tag, attrs={}, children=[])=>{const n=document.createElement(tag);Object.entries(attrs).forEach(([k,v])=>{if(k=="class") n.className=v; else if(k=="html") n.innerHTML=v; else n.setAttribute(k,v)});children.forEach(c=>n.appendChild(c));return n};
  const fmt = d=> new Date(d).toISOString().slice(0,10);
  const addDays = (d,days)=>{const nd=new Date(d);nd.setDate(nd.getDate()+days);return nd};
  const rangeDays=(start, dur)=>{const out=[]; for(let i=0;i<dur;i++) out.push(fmt(addDays(start,i))); return out};
  const rnd = (arr)=> arr[Math.floor(Math.random()*arr.length)];
  const idGen = (p, n)=> p + String(n).padStart(3,'0');

  // ---------- Seed Data ----------
  function seedMasterData(){
    S.mdLists = {
      Urgency:["AOG (Aircraft On Ground)","Routine"],
      Status:["Planned","In Progress","Completed"],
      Shop:["Engine Shop","Cleaning Shop","Test Cell"],
      Location:["Hangar 1","Hangar 2","Test Facility"],
      "Operation Type":["Inspection","Disassembly","Repair","Cleaning","Assembly","Test Run"],
      "Engine Model":["CFM56","LEAP-1A","GE90"],
      Customer:["Airline A","Airline B","Leasing Company"],
      "Request Type":["Overhaul","Quick Inspection","Deep Repair"]
    };
    S.requestTypeToOps = {
      "Overhaul":["Disassembly","Repair","Assembly","Test Run"],
      "Quick Inspection":["Inspection","Cleaning","Assembly","Test Run"],
      "Deep Repair":["Disassembly","Repair","Assembly","Test Run"]
    };
    S.opDur = {"Inspection":2,"Disassembly":3,"Repair":5,"Cleaning":1,"Assembly":4,"Test Run":2};
    S.shops = ["Engine Shop","Cleaning Shop","Test Cell"];
    S.shopCapabilities = {
      "Engine Shop":{ops:["Inspection","Disassembly","Repair","Assembly"], capPerDay:8, location:"Hangar 1", exceptions:[]},
      "Cleaning Shop":{ops:["Cleaning"], capPerDay:12, location:"Hangar 2", exceptions:[]},
      "Test Cell":{ops:["Test Run"], capPerDay:3, location:"Test Facility", exceptions:[]}
    };
    // seed a couple of Test Cell down days (exceptions)
    const today = fmt(new Date());
    S.shopCapabilities["Test Cell"].exceptions = [fmt(addDays(today,3)), fmt(addDays(today,9))];
  }

  function seedTransactions(){
    S.requests = []; S.operations = []; S.bookings = {};
    const models = S.mdLists["Engine Model"], customers = S.mdLists.Customer, urg = S.mdLists.Urgency, rtypes = S.mdLists["Request Type"];
    let rid = 1, oid = 1;

    for(let i=0;i<10;i++){
      const model = rnd(models);
      const serial = `${model} SN ${Math.floor(100000+Math.random()*900000)}`;
      const customer = Math.random()<0.4?customers[0]:rnd(customers);
      const urgency = Math.random()<0.35?"AOG (Aircraft On Ground)":"Routine";
      const rtype = rnd(rtypes);
      const reqDate = fmt(addDays(new Date(), -Math.floor(Math.random()*28)));
      const eta = estimateETA(rtype, reqDate);
      S.requests.push({id:idGen('R',rid++), engineModel:model, engineSerial:serial, customer, urgency, reqType:rtype, reqDate, eta, notes:""});
    }

    // For each request, schedule its 4 required ops in order, respecting capacity
    for(const R of S.requests){
      let lastEnd = new Date(R.reqDate);
      const ops = S.requestTypeToOps[R.reqType] || [];
      for(const ot of ops){
        const shop = findShopForOp(ot);
        if(!shop) continue;
        const dur = S.opDur[ot]||1;
        const start = findStartWithCapacity(shop, lastEnd, dur);
        const end = addDays(start, dur);
        const op = {id:idGen('O',oid++), reqId:R.id, shop, opType:ot, start:fmt(start), duration:dur, end:fmt(end), status:"Planned"};
        book(shop, start, dur);
        S.operations.push(op);
        lastEnd = end;
        if(S.operations.length>=30) break;
      }
      if(S.operations.length>=30) break;
    }
  }

  // ---------- Capacity & Scheduling ----------
  function findShopForOp(opType){
    return S.shops.find(sh => S.shopCapabilities[sh].ops.includes(opType));
  }
  function capFor(shop, date){
    const cap = S.shopCapabilities[shop].capPerDay || 0;
    const isDown = (S.shopCapabilities[shop].exceptions||[]).includes(date);
    const used = (((S.bookings[shop]||{})[date])||0);
    return {cap:isDown?0:cap, used, free: Math.max(0,(isDown?0:cap)-used), down:isDown};
  }
  function canFit(shop, startDate, dur){
    const days = rangeDays(startDate,dur);
    for(const d of days){ const c = capFor(shop,d); if(c.free<=0) return false; }
    return true;
  }
  function book(shop, startDate, dur){
    if(!S.bookings[shop]) S.bookings[shop] = {};
    const days = rangeDays(startDate,dur);
    for(const d of days){ S.bookings[shop][fmt(d)] = (S.bookings[shop][fmt(d)]||0)+1; }
  }
  function unbook(shop, startDate, dur){
    if(!S.bookings[shop]) return; const days = rangeDays(startDate,dur);
    for(const d of days){ const k=fmt(d); S.bookings[shop][k] = Math.max(0,(S.bookings[shop][k]||0)-1); }
  }
  function findStartWithCapacity(shop, earliest, dur){
    // search up to 120 days ahead
    let t = new Date(earliest);
    for(let i=0;i<120;i++){
      if(canFit(shop,t,dur)) return t; t = addDays(t,1);
    }
    return new Date(earliest);
  }
  function estimateETA(reqType, reqDate){
    const ops = S.requestTypeToOps[reqType]||[]; let total = 0; for(const o of ops) total += (S.opDur[o]||1);
    // simple buffer if Test Run present
    if(ops.includes("Test Run")) total += 1;
    return fmt(addDays(new Date(reqDate), total));
  }

  // ---------- Rendering ----------
  function initTabs(){
    const tabsEl = $('#tabs'); tabsEl.innerHTML = '';
    S.tabs.forEach(t=>{
      const btn = el('button',{class:'', html:t.replaceAll('_',' ')}); btn.addEventListener('click',()=>activateTab(t,btn)); tabsEl.appendChild(btn);
    });
    // activate first
    tabsEl.querySelector('button').classList.add('active');
  }
  function activateTab(name, btn){
    document.querySelectorAll('.tab').forEach(s=>s.classList.remove('active'));
    $('#tab-'+name).classList.add('active');
    document.querySelectorAll('nav.tabs button').forEach(b=>b.classList.remove('active'));
    if(btn) btn.classList.add('active'); else {
      document.querySelectorAll('nav.tabs button').forEach(b=>{ if(b.textContent===name.replaceAll('_',' ')) b.classList.add('active'); });
    }
    if(name==='KPI_Dashboard') renderKPI();
    if(name==='MD_Lists') { renderMDGrid(); renderMappingTable(); renderDurationTable(); renderJSONViewer(); }
    if(name==='TR_Maint_Requests') renderRequestsTable();
    if(name==='OP_Maint_Operations') renderOperationsTable();
  }

  function populateDropdowns(){
    // New Request
    fillSelect('#reqEngineModel', S.mdLists["Engine Model"]);
    fillSelect('#reqCustomer', S.mdLists.Customer);
    fillSelect('#reqUrgency', S.mdLists.Urgency);
    fillSelect('#reqType', S.mdLists["Request Type"]);
    $('#reqDate').value = fmt(new Date());

    // Capacity helper
    fillSelect('#capShop', S.shops);
    fillSelect('#capOpType', S.mdLists["Operation Type"]);

    // Op editor
    fillSelect('#opReqId', S.requests.map(r=>r.id));
    fillSelect('#opShop', S.shops);
    fillSelect('#opStatus', S.mdLists.Status);
    filterOpTypesByShop();

    // Filters
    fillSelect('#fltCustomer', ['(Tous)'].concat(S.mdLists.Customer));
    fillSelect('#fltUrgency', ['(Toutes)'].concat(S.mdLists.Urgency));
    fillSelect('#fltReqType', ['(Tous)'].concat(S.mdLists["Request Type"]));

    fillSelect('#fltOpReq', ['(Toutes)'].concat(S.requests.map(r=>r.id)));
    fillSelect('#fltOpShop', ['(Tous)'].concat(S.shops));
    fillSelect('#fltOpType', ['(Tous)'].concat(S.mdLists["Operation Type"]));
  }
  function fillSelect(sel, arr){ const s=$(sel); s.innerHTML=''; arr.forEach(v=> s.appendChild(el('option',{value:v, html:v}))); }

  function renderReqTypeHelper(){
    const box = $('#reqTypeHelper'); box.innerHTML='';
    Object.entries(S.requestTypeToOps).forEach(([rtype,ops])=>{
      const line = el('div',{class:'chips'});
      line.appendChild(el('div',{class:'chip',html:`<strong>${rtype}</strong>`}));
      ops.forEach(o=> line.appendChild(el('div',{class:'chip',html:o})));
      box.appendChild(line);
    });
  }
  function renderShopHelper(){
    const box = $('#shopHelper'); box.innerHTML='';
    S.shops.forEach(sh=>{
      const sc = S.shopCapabilities[sh];
      const wrap = el('div',{class:'helper', html:`<div><strong>${sh}</strong> • ${sc.location} • Cap/jour: <strong>${sc.capPerDay}</strong></div>`});
      const chips = el('div',{class:'chips'});
      sc.ops.forEach(o=> chips.appendChild(el('div',{class:'chip',html:o})));
      wrap.appendChild(chips);
      if((sc.exceptions||[]).length){
        wrap.appendChild(el('div',{class:'note',html:`Exceptions: ${(sc.exceptions).join(', ')}`}));
      }
      box.appendChild(wrap);
    });
  }
  function onCapLookup(){
    const shop = $('#capShop').value; const date = $('#capDate').value||fmt(new Date());
    const op = $('#capOpType').value; const cap = capFor(shop,date);
    const msg = cap.down? `Atelier <b>${shop}</b> indisponible le ${date} (exception).` : `Capacité ${shop} le ${date}: <b>${cap.free}</b> slots libres / ${cap.cap} (utilisés: ${cap.used}).`;
    $('#capResult').innerHTML = msg + (op && !S.shopCapabilities[shop].ops.includes(op) ? ` <span class="muted">(${op} non supportée par ${shop})</span>`: '');
  }

  function renderRequestsTable(){
    const tbody = $('#requestsTbody'); tbody.innerHTML='';
    const fC = $('#fltCustomer').value, fU=$('#fltUrgency').value, fT=$('#fltReqType').value;
    const rows = S.requests.filter(r=> (fC==='(Tous)'||!fC||r.customer===fC) && (fU==='(Toutes)'||!fU||r.urgency===fU) && (fT==='(Tous)'||!fT||r.reqType===fT));
    for(const r of rows){
      const opsCount = S.operations.filter(o=>o.reqId===r.id).length;
      const tr = el('tr',{},[
        el('td',{html:`<span class="link" data-jump-op="${r.id}">${r.id}</span>`}),
        el('td',{html:r.engineModel}),
        el('td',{html:r.engineSerial}),
        el('td',{html:r.customer}),
        el('td',{html:`<span class="pill ${r.urgency.startsWith('AOG')?'aog':'routine'}">${r.urgency}</span>`}),
        el('td',{html:r.reqType}),
        el('td',{html:r.reqDate}),
        el('td',{html:r.eta}),
        el('td',{html:`<span class="link" data-jump-op="${r.id}">${opsCount}</span>`})
      ]);
      tbody.appendChild(tr);
    }
    // link jumps
    tbody.querySelectorAll('[data-jump-op]').forEach(a=> a.addEventListener('click', (e)=>{
      const id = e.target.getAttribute('data-jump-op');
      $('#fltOpReq').value = id; activateTab('OP_Maint_Operations'); renderOperationsTable();
    }));
  }

  function renderOperationsTable(){
    const tbody = $('#operationsTbody'); tbody.innerHTML='';
    const fR=$('#fltOpReq').value, fS=$('#fltOpShop').value, fT=$('#fltOpType').value;
    const rows = S.operations.filter(o=> (fR==='(Toutes)'||!fR||o.reqId===fR) && (fS==='(Tous)'||!fS||o.shop===fS) && (fT==='(Tous)'||!fT||o.opType===fT));
    for(const o of rows){
      const tr = el('tr',{},[
        el('td',{html:`<span class="link" data-edit-op="${o.id}">${o.id}</span>`}),
        el('td',{html:`<span class="link" data-jump-req="${o.reqId}">${o.reqId}</span>`}),
        el('td',{html:o.shop}),
        el('td',{html:o.opType}),
        el('td',{html:o.start}),
        el('td',{html:String(o.duration)}),
        el('td',{html:o.end}),
        el('td',{html:o.status})
      ]);
      tbody.appendChild(tr);
    }
    tbody.querySelectorAll('[data-edit-op]').forEach(a=> a.addEventListener('click',(e)=>{
      const id = e.target.getAttribute('data-edit-op'); const op=S.operations.find(x=>x.id===id); if(!op) return;
      $('#opMode').value='Édition'; $('#opId').value=op.id; $('#opReqId').value=op.reqId; $('#opShop').value=op.shop; filterOpTypesByShop(); $('#opType').value=op.opType; $('#opStart').value=op.start; $('#opDur').value=op.duration; computeOpEnd(); $('#opStatus').value=op.status; $('#opDelete').disabled=false; $('#opMsg').textContent=''; activateTab('FORM_Edit_Operations'); renderOpShopHelper();
    }));
    tbody.querySelectorAll('[data-jump-req]').forEach(a=> a.addEventListener('click',(e)=>{
      const id = e.target.getAttribute('data-jump-req'); $('#fltCustomer').value='(Tous)'; $('#fltUrgency').value='(Toutes)'; $('#fltReqType').value='(Tous)'; activateTab('TR_Maint_Requests');
      // highlight row (simple jump)
      renderRequestsTable();
    }));
  }

  function renderMDGrid(){
    const grid = $('#mdGrid'); grid.innerHTML='';
    Object.entries(S.mdLists).forEach(([name, list])=>{
      const ta = el('textarea',{rows:6}); ta.value = list.join('\n');
      ta.addEventListener('change',()=>{ S.mdLists[name] = ta.value.split('\n').map(x=>x.trim()).filter(Boolean); });
      const card = el('div',{class:'card'},[ el('h3',{html:name}), ta ]);
      grid.appendChild(card);
    });
  }
  function renderMappingTable(){
    const tb = $('#mapTbody'); tb.innerHTML='';
    Object.entries(S.requestTypeToOps).forEach(([k,arr])=>{
      const tr = el('tr',{},[ el('td',{html:k}), el('td',{html:arr.join(' → ')}) ]); tb.appendChild(tr);
    });
  }
  function renderDurationTable(){
    const tb = $('#durTbody'); tb.innerHTML='';
    Object.entries(S.opDur).forEach(([k,v])=>{
      const inp = el('input',{type:'number', value:String(v), min:'1', style:'width:100px'});
      inp.addEventListener('change',()=>{ S.opDur[k] = Math.max(1, parseInt(inp.value||'1',10)); $('#reqType').dispatchEvent(new Event('change')); renderKPI(); });
      const tr = el('tr',{},[ el('td',{html:k}), el('td',{},[inp]) ]); tb.appendChild(tr);
    });
  }
  function renderJSONViewer(){
    const replacer = (k,v)=> v; // flat data only
    $('#jsonOut').textContent = JSON.stringify(S, replacer, 2);
  }

  function renderKPI(){
    // On-time % for AOG: a request is on-time if last operation end <= ETA
    const aogReqs = S.requests.filter(r=> r.urgency.startsWith('AOG'));
    let ontime = 0, total = 0;
    for(const r of aogReqs){
      const ops = S.operations.filter(o=>o.reqId===r.id);
      if(!ops.length) continue; total++;
      const lastEnd = ops.map(o=>o.end).sort().slice(-1)[0];
      if(lastEnd && lastEnd <= r.eta) ontime++;
    }
    const pct = total?Math.round(100*ontime/total):0;
    $('#kpiAOG').innerHTML = `AOG on-time: <b>${pct}%</b> (${ontime}/${total})`;
    $('#kpiAOGBar').style.width = pct+'%';

    // Per-shop load heatmaps for next 14 days
    const today = new Date();
    const cont = $('#shopHeatContainer');
    cont.innerHTML = '';
    const summary = [];
    S.shops.forEach(shop=>{
      const ratios = [];
      const row = el('div',{class:'heatmapRow'});
      const hm = el('div',{class:'heatmap'});
      for(let i=0;i<14;i++){
        const d = fmt(addDays(today,i));
        const c = capFor(shop,d);
        const ratio = c.cap ? c.used/c.cap : 1; // if down, treat as fully used
        ratios.push(ratio);
        const cell = el('div',{class:'cell'});
        cell.style.background = c.down ? '#111827' : ratioColor(ratio);
        cell.title = `${shop} • ${d} • ${c.used}/${c.cap} utilisés` + (c.down?' (exception)':'');
        hm.appendChild(cell);
      }
      const avgShop = Math.round(avg(ratios)*100);
      row.appendChild(el('div',{class:'label', html:`${shop} — <b>${avgShop}%</b>`}));
      row.appendChild(hm);
      cont.appendChild(row);
      summary.push(`${shop}: <b>${avgShop}%</b>`);
    });
    $('#kpiShopSummary').innerHTML = summary.join(' • ');
  }
  const avg = arr => arr.length? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
  function ratioColor(r){
    // 0..1 -> light to deep accent
    const p = Math.min(1, Math.max(0,r)); const g = 230 - Math.round(150*p);
    return `rgb(${230-Math.round(50*p)}, ${g}, ${255-Math.round(180*p)})`;
  }

  // ---------- Forms & Events ----------
  function bindEvents(){
    // New Request
    ['#reqType','#reqDate'].forEach(sel=> $(sel).addEventListener('change', recalcEstEnd));
    $('#btnRecalcEta').addEventListener('click', recalcEstEnd);
    $('#newReqForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const engineModel=$('#reqEngineModel').value.trim();
      const engineSerial=$('#reqEngineSerial').value.trim();
      const customer=$('#reqCustomer').value; const urgency=$('#reqUrgency').value; const reqType=$('#reqType').value; const reqDate=$('#reqDate').value; const eta=$('#reqEstEnd').value || estimateETA(reqType, reqDate); const notes=$('#reqNotes').value;
      if(!engineModel||!engineSerial||!customer||!urgency||!reqType||!reqDate){ alert('Champs requis manquants.'); return; }
      const id = idGen('R', S.requests.length? parseInt(S.requests[S.requests.length-1].id.slice(1))+1 : 1);
      S.requests.push({id, engineModel, engineSerial, customer, urgency, reqType, reqDate, eta, notes});
      renderRequestsTable(); populateDropdowns(); renderJSONViewer(); alert('Demande créée: '+id);
      // clear minimal
      $('#reqEngineSerial').value=''; $('#reqNotes').value='';
    });

    // Capacity Lookup
    $('#capCheck').addEventListener('click', onCapLookup);

    // Op Editor
    $('#opShop').addEventListener('change', filterOpTypesByShop);
    $('#opType').addEventListener('change', ()=>{ const t=$('#opType').value; if(S.opDur[t]) $('#opDur').value=S.opDur[t]; computeOpEnd(); renderOpShopHelper(); });
    $('#opStart').addEventListener('change', computeOpEnd);
    $('#opDur').addEventListener('change', computeOpEnd);

    $('#opForm').addEventListener('submit', (e)=>{
      e.preventDefault(); const msg=$('#opMsg'); msg.textContent='';
      const id = $('#opId').value; const reqId=$('#opReqId').value; const shop=$('#opShop').value; const opType=$('#opType').value; const start=$('#opStart').value; const dur=parseInt($('#opDur').value||'1',10); const end=$('#opEnd').value; const status=$('#opStatus').value;
      if(!reqId||!shop||!opType||!start||!dur){ alert('Champs requis manquants.'); return; }
      if(!S.shopCapabilities[shop].ops.includes(opType)){ alert('Opération non supportée par cet atelier.'); return; }
      if(!canFit(shop, new Date(start), dur)){ msg.textContent='Pas de capacité sur cette plage. Essayez Auto-planifier.'; msg.style.color='var(--danger)'; return; }
      if(id){
        const old = S.operations.find(o=>o.id===id);
        if(old){ unbook(old.shop, new Date(old.start), old.duration); Object.assign(old, {reqId, shop, opType, start, duration:dur, end, status}); book(shop, new Date(start), dur); }
      } else {
        const nid = idGen('O', S.operations.length? parseInt(S.operations[S.operations.length-1].id.slice(1))+1 : 1);
        S.operations.push({id:nid, reqId, shop, opType, start, duration:dur, end, status}); book(shop, new Date(start), dur); $('#opId').value = nid; $('#opMode').value='Édition'; $('#opDelete').disabled=false;
      }
      renderOperationsTable(); renderJSONViewer(); renderKPI(); msg.textContent='Opération enregistrée.'; msg.style.color='var(--accent)';
    });
    $('#opDelete').addEventListener('click',()=>{
      const id = $('#opId').value; if(!id) return; const i = S.operations.findIndex(o=>o.id===id); if(i>-1){ const op=S.operations[i]; unbook(op.shop, new Date(op.start), op.duration); S.operations.splice(i,1); renderOperationsTable(); renderJSONViewer(); renderKPI(); $('#opReset').click(); alert('Opération supprimée.'); }
    });
    $('#opReset').addEventListener('click',()=>{ $('#opMode').value='Nouveau'; $('#opId').value=''; $('#opReqId').value=S.requests[0]?.id||''; $('#opShop').value=S.shops[0]; filterOpTypesByShop(); $('#opType').value=$('#opType').options[0]?.value||''; const t=$('#opType').value; if(S.opDur[t]) $('#opDur').value=S.opDur[t]; $('#opStart').value=fmt(new Date()); computeOpEnd(); $('#opStatus').value=S.mdLists.Status[0]; $('#opDelete').disabled=true; $('#opMsg').textContent=''; renderOpShopHelper(); });
    $('#opAutoSlot').addEventListener('click',()=>{
      const shop=$('#opShop').value; const dur=parseInt($('#opDur').value||'1',10); const earliest = $('#opStart').value? new Date($('#opStart').value): new Date(); const start = findStartWithCapacity(shop, earliest, dur); $('#opStart').value = fmt(start); computeOpEnd(); $('#opMsg').textContent='Créneau trouvé et appliqué.'; $('#opMsg').style.color='var(--accent-2)';
    });

    // Filters
    $('#fltCustomer').addEventListener('change', renderRequestsTable);
    $('#fltUrgency').addEventListener('change', renderRequestsTable);
    $('#fltReqType').addEventListener('change', renderRequestsTable);
    $('#btnClearFilters').addEventListener('click',()=>{ $('#fltCustomer').value='(Tous)'; $('#fltUrgency').value='(Toutes)'; $('#fltReqType').value='(Tous)'; renderRequestsTable(); });

    $('#fltOpReq').addEventListener('change', renderOperationsTable);
    $('#fltOpShop').addEventListener('change', renderOperationsTable);
    $('#fltOpType').addEventListener('change', renderOperationsTable);
    $('#btnClearOpFilters').addEventListener('click',()=>{ $('#fltOpReq').value='(Toutes)'; $('#fltOpShop').value='(Tous)'; $('#fltOpType').value='(Tous)'; renderOperationsTable(); });

    // JSON viewer actions
    $('#jsonCopy').addEventListener('click',()=>{ navigator.clipboard.writeText($('#jsonOut').textContent); alert('JSON copié.'); });
    $('#jsonDownload').addEventListener('click',()=>{ const blob = new Blob([$('#jsonOut').textContent],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='maestro-data.json'; a.click(); URL.revokeObjectURL(a.href); });

    // Self-tests
    $('#btnSelfTest').addEventListener('click', runSelfTest);
  }

  function filterOpTypesByShop(){
    const shop = $('#opShop').value || S.shops[0]; const ops = S.shopCapabilities[shop].ops; fillSelect('#opType', ops); if(ops.length){ $('#opType').value=ops[0]; if(S.opDur[ops[0]]) $('#opDur').value=S.opDur[ops[0]]; computeOpEnd(); }
  }
  function computeOpEnd(){
    const s = $('#opStart').value; const d = parseInt($('#opDur').value||'1',10); if(s){ $('#opEnd').value = fmt(addDays(new Date(s), d)); }
  }
  function recalcEstEnd(){
    const rtype = $('#reqType').value; const date = $('#reqDate').value; if(rtype && date){ $('#reqEstEnd').value = estimateETA(rtype, date); }
  }
  function renderOpShopHelper(){
    const shop = $('#opShop').value; const sc = S.shopCapabilities[shop]; const box = $('#opShopHelper'); box.innerHTML='';
    const ops = sc.ops.map(o=>`<span class="chip">${o}</span>`).join(' ');
    box.innerHTML = `<div><strong>${shop}</strong> — ${sc.location}</div><div>Cap/jour: <b>${sc.capPerDay}</b></div><div class="chips" style="margin-top:6px">${ops}</div>` + (sc.exceptions?.length? `<div class="note">Exceptions: ${sc.exceptions.join(', ')}</div>`: '');
  }

  // ---------- Self-tests (lightweight) ----------
  function runSelfTest(){
    const out = [];
    try{ out.push(ok(typeof renderKPI === 'function', 'renderKPI est défini.')); }catch(e){ out.push(ko('renderKPI non défini.')); }

    try{ out.push(ok(S.requests.length>0 && S.operations.length>0, `Données seedées (requests=${S.requests.length}, ops=${S.operations.length}).`)); }catch(e){ out.push(ko('Seed de données non réalisé.')); }

    try{ out.push(ok(!document.getElementById('tcHeat') && !document.getElementById('kpiTC'), 'Aucune référence obsolète (#tcHeat/#kpiTC).')); }catch(e){ out.push(ko('Références obsolètes détectées.')); }

    try{ renderKPI(); out.push(ok($('#shopHeatContainer').children.length>0, 'Heatmaps par atelier rendues.')); }catch(e){ out.push(ko('renderKPI a levé une erreur.')); }

    try{
      const allGood = S.operations.every(o=> (S.shopCapabilities[o.shop]||{ops:[]}).ops.includes(o.opType));
      out.push(ok(allGood, 'Chaque opération est compatible avec son atelier.'));
    }catch(e){ out.push(ko('Compatibilité atelier/opération non vérifiée.')); }

    $('#selfTest').innerHTML = out.map(x=>`• ${x}`).join('<br>');
  }
  const ok = (cond,msg)=> cond? `✅ ${msg}` : `❌ ${msg}`;
  const ko = msg => `❌ ${msg}`;

  // ---------- Boot ----------
  function init(){
    seedMasterData();
    seedTransactions();
    initTabs();
    populateDropdowns();
    renderReqTypeHelper();
    renderShopHelper();
    renderRequestsTable();
    renderOperationsTable();
    renderMDGrid();
    renderMappingTable();
    renderDurationTable();
    renderKPI();
    renderJSONViewer();
    bindEvents();
    $('#opReset').click();
    // auto-run self tests on load
    runSelfTest();
  }
  init();
  </script>
</body>
</html>
